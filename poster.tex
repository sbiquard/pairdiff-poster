% Inspired from
% https://github.com/andiac/gemini-cam
% a fork of https://github.com/anishathalye/gemini
% also refer to https://github.com/k4rtik/uchicago-poster

\documentclass[final]{beamer}

% ====================
% Packages
% ====================

\usepackage[T1]{fontenc}
\usepackage[utf8]{luainputenc}
\usepackage{lmodern}
\usepackage[orientation=portrait,size=a0,scale=1.0]{beamerposter}
\usetheme{gemini}
\usecolortheme{cnrs}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{tikz}
\usepackage{pgfplots}
\pgfplotsset{compat=1.18}
\usepackage{anyfontsize}

\usepackage{unicode-math}
\setmathfont[Scale=MatchUppercase]{libertinusmath-regular.otf}

\usepackage[margin=10pt,
            % labelfont=bf,
            % labelsep=endash,
            format=plain,
]{caption}
\usepackage{amsmath,amssymb}
\usepackage{siunitx}
\usepackage{physics2}
\usephysicsmodule{ab} % automatic bracing

% macros for \vb, \va and \vu
\makeatletter
\newcommand\vb{\@ifstar\boldsymbol\mathbf}
\newcommand\va[1]{\@ifstar{\vec{#1}}{\vec{\mathrm{#1}}}}
\newcommand\vu[1]{%
\@ifstar{\hat{\boldsymbol{#1}}}{\hat{\mathbf{#1}}}}
\makeatother

\newcommand{\transpose}[1]{\ensuremath{#1^{\mathsf T}}}

% ====================
% Lengths
% ====================

% If you have N columns, choose \sepwidth and \colwidth such that
% (N+1)*\sepwidth + N*\colwidth = \paperwidth
\newlength{\sepwidth}
\newlength{\colwidth}
\setlength{\sepwidth}{0.025\paperwidth}
\setlength{\colwidth}{0.45\paperwidth}

\newcommand{\separatorcolumn}{\begin{column}{\sepwidth}\end{column}}

% ====================
% Title
% ====================

\title{Map-making strategies for next generation CMB polarization experiments}

\author{Simon Biquard \inst{1}}
% \and Another Author \inst{2}

\institute[shortinst]{\inst{1} AstroParticule et Cosmologie, Paris, France}
% \samelineand \inst{2} Another Institute

% ====================
% Footer (optional)
% ====================

\footercontent{
  % \href{https://www.example.com}{https://www.example.com} \hfill
  Moriond Cosmology 2024 - La Thuile --- Poster Session \hfill
  \href{mailto:biquard@apc.in2p3.fr}{biquard@apc.in2p3.fr}
}
% (can be left out to remove footer)

% ====================
% Logo (optional)
% ====================

% use this to include logos on the left and/or right side of the header:
\logoleft{\includegraphics[height=7cm]{logos/logo_apc.png}}
\logoright{
  \includegraphics[height=6cm]{logos/logo_upcite.png},
  \includegraphics[height=6cm]{logos/logo_cnrs_bleu.png}
}

% ====================
% Body
% ====================

\begin{document}

% Refer to https://github.com/k4rtik/uchicago-poster
% logo: https://www.cam.ac.uk/brand-resources/about-the-logo/logo-downloads
% \addtobeamertemplate{headline}{}
% {
%     \begin{tikzpicture}[remember picture,overlay]
%       \node [anchor=north west, inner sep=3cm] at ([xshift=-2.5cm,yshift=1.75cm]current page.north west)
%       {\includegraphics[height=7cm]{logos/unott-logo.eps}}; 
%     \end{tikzpicture}
% }

\begin{frame}[t]
  \begin{columns}[t]
    \separatorcolumn

    \begin{column}{\colwidth}

      \begin{block}{Introduction}

        \emph{Map-making} is the reconstruction of the observed sky from the time-ordered data (TOD) collected by a telescope.
        It compresses the volume of data by many orders of magnitude, while trying to preserve cosmological information.

        In the quest for B-mode polarization of the CMB, modern experiments are lining up tens, even hundreds of thousands of detectors to extract the primordial signal.
        As a result, the size of the TOD is increasing to an unprecedented volume, challenging our ability to analyze it correctly and efficiently.

        % keep this table or not?
        \begin{table}
          \centering
          \begin{tabular}{l c c c}
            \toprule
            \text{}     & \textbf{Polarbear} & \textbf{SO} & \textbf{CMB-S4} \\
            \midrule
            Data volume & 100 TB             & 2 PB        & 50 PB           \\
            CPU hours   & 20 k               & 35 M        & 500 M           \\
            \bottomrule
          \end{tabular}
          \caption{Data volume and current CPU time needed to produce \emph{one} sky map.}
        \end{table}

      \end{block}

      \begin{alertblock}{Quick review of map-making flavors}

        \heading{Data model and estimators}

        \begin{equation}\label{eq:data_model}
          d = P s + n
        \end{equation}

        This is the usual assumed data model for the map-making problem.

        \begin{itemize}
          \item $d$ = TOD (calibrated)
          \item $P$ = pointing matrix, encodes scanning and orientation of the telescope
          \item $s$ = true sky map
          \item $n$ = noise vector
        \end{itemize}

        Map-making is just a \emph{linear operation}, $m = Ld$, mapping the TOD to an estimator $m$ of the true sky map.

        \begin{table}
          \centering
          \begin{tabular}{l l c c}
            \toprule
            \textbf{Method} & \textbf{Operator} $L$                                            & \textbf{Pros}           & \textbf{Cons} \\
            \midrule
            Binning         & \( \pab{\transpose{P} \Lambda P}^{-1} \transpose{P} \Lambda \)   & unbiased, cheap         & complex noise \\
            \midrule
            GLS             & \( \pab{\transpose{P} C_n^{-1} P}^{-1} \transpose{P} C_n^{-1} \) & unbiased, min. variance & expensive     \\
            \midrule
            Filter-and-bin  & \( \pab{\transpose{P} {\Lambda P}}^{-1} \transpose{P} F \)       & easy to compute         & biased        \\
            \midrule
            Templates       & \( \pab{\transpose{P} F P}^{-1} \transpose{P} F \)               & unbiased filtering      & iterative     \\
            \bottomrule
          \end{tabular}
          \caption{Comparison of different map-making approaches. Legend: $\Lambda$ = diagonal noise weights; $C_n^{-1}$ = noise covariance matrix; $F$ = filtering and weighting operator.}
        \end{table}

        \heading{Observing from the ground}

        Ground-based experiments have to deal with two specific contaminants which are very bright compared to the CMB:

        \begin{itemize}
          \item \emph{atmospheric signal}, a major source of noise correlations
          \item \emph{ground pickup}, typically due to the far side-lobes of the beam
        \end{itemize}

        Those contaminants are largely unpolarized, which motivates the \textbf{pair differencing} approach, where the timestreams of two orthogonal detectors are subtracted in order to eliminate non polarized signals.

      \end{alertblock}

      \begin{block}{Evaluation of the pair differencing approach}

        I use the map-making library \texttt{mappraiser}~\cite{ElBouhargani:2021umq} to process simulations produced with the \texttt{TOAST} software:

        \begin{itemize}
          \item instrument: SO-SAT @ 90 GHz
          \item schedule: one day per month during one year
          \item sky: CMB lensed scalar anisotropies (from Planck FFP10 simulations)
          \item high-resolution atmosphere simulation
          \item instrumental noise
          \item gain errors in detector pairs
          \item in the future: elliptical beams
        \end{itemize}

        \emph{Figure of merit ?}

      \end{block}

    \end{column}

    \separatorcolumn

    \begin{column}{\colwidth}

      \begin{block}{Results: gain errors}

        \begin{figure}
          \centering
          \includegraphics[width=0.8\textwidth]{figures/comparison_bb.png}
          \caption{B-mode spectrum in different configurations. Solid lines are the measured spectrum, dotted lines are the difference with respect to the input spectrum (residual).}
        \end{figure}
      \end{block}

      \begin{exampleblock}{Numerical advantages of pair differencing}

        The map-making equation is solved \emph{iteratively} using a conjugate gradient (CG) algorithm.
        If $m_t$ is the approximate solution obtained at the $t$-th step of the algorithm, and $m_\ast$ the true solution, then an upper bound of the error is given by:

        \begin{equation}
          \Vab{m_\ast - m_t}_A \leq 2 \bab{\frac{\sqrt{\kappa} - 1}{\sqrt{\kappa} + 1}}^t \Vab{m_\ast - m_0}_A
        \end{equation}

        So the convergence rate of the algorithm essentially depends on the \emph{condition number} $\kappa$ of the system matrix.
        Strong noise correlations increase $\kappa$. By removing most of the intensity signal of the atmosphere, we also drastically improve the convergence speed of the algorithm.

        \begin{figure}
          \centering
          \includegraphics[width=0.8\textwidth]{figures/convergence.png}
          \caption{Convergence comparison with and without atmospheric correlations.}
        \end{figure}

      \end{exampleblock}

      \begin{block}{Conclusion / Discussion ?}

        In what conditions is pair differencing reasonable to use?
        What do we lose? What do we gain?

      \end{block}

      \begin{block}{References}

        \nocite{*}
        \footnotesize{\bibliographystyle{plain}\bibliography{poster}}

      \end{block}

    \end{column}

    \separatorcolumn
  \end{columns}
\end{frame}

\end{document}
